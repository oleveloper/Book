---
layout: post
title: "Kubernetes_44 View Certificate Details"
date: 2023-01-17
last_modified_at: 2023-01-17
categories: [Kubernetes]
tags: [Kubernetes]
---

# View Certificate Details

팀의 관리자로서 새로운 팀에 Join하여 Kubernetes 환경을 관리한다고 가정하자.    
당신은 환경에 인증서와 관련된 여러 가지 문제가 있다고 듣게 된다. 따라서 전체 클러스터의 모든 인증서에 대한 상태 검사를 수행해야 한다.    
그럼 어떤 일을 해야할까?    

먼저 클러스터가 어떻게 설정되었는지 아는 것이 중요하다.    
쿠버네티스 클러스터를 배포하는 데 사용할 수 있는 다양한 솔루션이 있으며, 이것들은 인증서를 생성하고 관리하는 데 다양한 방법을 사용한다.    
시작부터 쿠버네티스 클러스터를 배포하는 경우에는 유저가 모든 인증서를 직접 생성해야 할 것이다.    
Kube ADM과 같은 자동화된 프로비저닝 툴을 사용하는 경우 클러스터를 자동으로 생성하고 구성한다.    
시작부터 직접 Components를 노드의 native service로 배포하는 동안, Kube ADM Tool을 사용한다면 Components를 pod로 배포할 수 있게 된다.    
따라서 올바른 정보를 보기 위해서는 어디를 봐야 하는지 알아야 한다.    

여기에서는 Kube ADM이 제공하는 클러스터를 예로 들어 보도록 하자.    
health check를 수행하려면 시스템에 사용되는 모든 인증서를 식별하는 것부터 해야 한다.    
샘플 Excel 스프레드시트를 작성해보자. 이 스프레드 시트의 목적은 사용된 인증서 파일의 목록을 만드는 것이다.    

그럼 이 스프레드 시트를 채우기 위해서는 어떻게 정보를 얻어야 할까?    
사용된 인증서 파일부터 보도록 하자.    
이를 위해서는 Kube ADM에서 설정한 환경의 /etsy/kubernetes/manifests 폴더에서 Kube API 서버 정의 파일을 한다.    
API 서버를 시작하는 데 사용되는 명령에는 사용하는 모든 인증서에 대한 정보가 있다. 각 용도에 사용되는 인증서 파일을 식별하고 기록한다.    
그 다음, 각 인증서를 가져와 해당 인증서에 대한 자세한 내용을 확인해보자.    

예를 들어 API 서버 인증서 파일을 보자.    
```sh
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout
```
open SSL X509 명령을 실행하고 인증서 파일을 입력하여 인증서를 디코딩하고 세부 정보를 볼 수 있다.    

먼저 섹션 아래 인증서의 이름을 보도록 하자. 이 경우에는 kube-apiserver이다.    
kube-apiserver를 대체할 수 있는 이름들이 있으므로 모든 이름이 있는지 확인해야 한다.   
그런 다음 인증서 유효성 섹션을 확인하고 만료 날짜를 식별한 다음 인증서 발급자를 확인 해보자.    
인증서 발급자는 인증서를 발급한 CA여야 한다.    
kube adm은 쿠버네티스 CA를 쿠버네티스 자체로 명명한다.    

동일한 절차에 따라 다른 모든 인증서에 대한 정보를 식별해보자.    
찾아야 할 사항: 올바른 alternative name가 있는지 확인하고, 인증서가 올바른 organization에 속해 있는지, 가장 중요한 것은 인증서가 올바른 발급자(CA)에 의해 발급되고 인증서가 만료되지 않았는지 확인한다.    
인증서 요구 사항은 Kubernetes 설명서 페이지에 자세히 나와 있으니 참고하도록 한다.    

이슈가 발생하면 로그를 확인해야 할 것이다.    
클러스터를 처음부터 직접 설정하고 OS에서 서비스가 "native services"로 구성된 경우 OS logging 기능을 사용하여 서비스 로그를 한다.    
kube adm을 사용하여 클러스터를 설정하는 경우 다양한 컴포넌트가 pod로 배포된다. 따라서 kubectl logs 명령 뒤에 pod 이름을 사용하여 로그를 확인할 수 있다.    
```
kubectl logs etcd-master
```

때때로 쿠버네티스 API 서버 또는 etcd 서버와 같은 핵심 컴포넌트가 중단 된 경우 kubectl 명령이 동작하지 않는다.   
이 경우 로그를 가져오려면 Docker로 한 단계 내려가야 한다.   
Docker 명령을 사용하여 모든 컨테이너를 나열한 다음 Docker logs 명령과 컨테이너 ID를 사용하여 로그를 볼 수 있다.   
```
docker ps -a

docker logs 87fc
```



