---
layout: post
title: "Kubernetes_37 OS Upgrades"
date: 2023-01-13
last_modified_at: 2023-01-13
categories: [Kubernetes]
tags: [Kubernetes]
---

# OS Upgrades

기반 소프트웨어 업그레이드 또는 클러스터에 보안 패치 등의 유지 보수 목적으로 노드를 중단해야 하는 경우가 있다.    
이번에는 이런 경우를 처리하는 데에 사용될 수 있는 옵션을 살펴보자.   

애플리케이션을 지원하는 몇 개의 노드와 Pod가 있는 클러스터가 있다.   
이 노드 중 하나가 중단되면 어떻게 될까?    
물론 Pods에는 접근할 수 없을 것이다. (노드가 중단되었으므로)   
이러한 Pod를 배포한 방법에 따라 유저가 영향을 받을 수 있다.       

예를 들어, Blue pod의 복제본이 여러 개 있기 때문에 Blue 애플리케이션에 액세스하는 사용자는 온라인 상태의 다른 Blue pod를 통해 서비스를 받을 때 영향을 받지 않는다.    
그러나 Green 애플리케이션을 사용하는 유일한 pod이기 때문에 Green Pod에 액세스하는 사용자는 영향을 받는다.   

이 경우에 쿠버네티스는 무엇을 할까?   
노드가 다시 바로 온라인 상태가 되면 kubelet 프로세스가 시작되고, Pod가 다시 온라인 상태가 된다.   
그러나 노드가 5분 이상 중단된 경우 Pod는 해당 노드에서 종료된다. 쿠버네티스는 이것들이 죽었다고 생각한다.   
Pod가 Replica set의 일부인 경우, Pod는 다른 노드에서 재생성된다.   

Pod가 다시 온라인 상태가 될 때까지 대기하는 시간을 pod eviction timeout이라고 하며,   
컨트롤러 매니저에 Default 5분으로 설정된다.   
따라서 노드가 오프라인으로 전환될 때마다 마스터 노드는 최대 5분동안 기다렸다가 노드가 비활성 상태인 것으로 간주한다.    
Pod eviction timeout 초과 후 노드가 다시 온라인 상태가 되면 스케줄 된 Pod 없이 공백으로 표시된다.   

Blue pod는 Replica set의 일부이므로 다른 노드에서 새 Pod가 생성된다.   
하지만 Green Pod는 Replica set의 일부가 아니기 때문에 그냥 사라지게 된다.   

따라서 노드에서 수행해야 할 유지 관리 작업이 있는 경우, 노드에서 실행 중인 워크로드에 다른 replicas가 있는 것을 알고 있으며,   
짧은 시간 동안 작업이 중단되고 노드가 5분 내에 다시 온라인 상태가 될 것이 확실한 경우 빠른 업그레이드 및 재부팅을 수행할 수 있다.   
그러나 노드가 5분 내에 온라인 상태로 돌아갈 수 있을 지에 대한 여부는 확실하지 않다.   

노드 상태가 돌아올 것인지 확신할 수 없기 때문에, 이 작업을 하는 더 안전한 방법을 선택할 수 있다.   
모든 워크로드를 의도적으로 노드에서 방출(drain)하여 워크로드가 클러스터의 다른 노드로 이동되도록 할 수 있다.   

엄밀하게 말하자면, Pod들은 이동하지는 않는다. 노드를 방출하면 노드에서 Pod가 정상적으로 종료되고 다른 노드에서 재생성된다.   
노드가 unschedule 로 표시되어 있으므로, restriction을 제거할 때까지 이 노드에서 pod를 예약할 수는 없다.   
이제 pod가 다른 노드에서 안전하므로 첫번쨰 노드를 재부팅 할 수 있다.    
다시 온라인 상태가 되어도 예약할 수는 없다.   

이 다음 pod를 예약할 수 있도록 uncordon 처리를 해야한다.   
여기서 기억할 점은 다른 노드로 이동된 pod는 자동으로 복구되지 않는다는 점이다.    
pod 중 하나가 삭제되었거나 클러스터에 새 pod가 생성된 경우 이 노드에 생성된다.   

drain, uncordon 외에도 cordon이라고 불리는 또 다른 명령이 있다.   
Cordon는 단순히 노드를 스케줄링 할 수 없는 상태로 표시한다.   
drain과는 달리 기존 노드에서 pod를 종료하거나 이동시키지 않는다.    
